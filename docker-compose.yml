version: '3.8'

services:
  # Avatar Application (Node.js + Express)
  avatar:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    
    # Exponer puertos: 3000 para la app y 4040 para ngrok web interface
    ports:
      - "3000:3000"
      - "4040:4040"
    
    # IMPORTANTE: No especificar container_name en Coolify - Coolify lo maneja automáticamente
    # container_name: avatar-app  # Comentado para que Coolify lo maneje
    
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - DID_API_KEY=${DID_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-deepseek/deepseek-chat}
      - OPENROUTER_VISION_MODEL=${OPENROUTER_VISION_MODEL:-openai/gpt-4o-mini}
      - OPENROUTER_AUDIO_MODEL=${OPENROUTER_AUDIO_MODEL:-openai/whisper}
      - OPENROUTER_APP_URL=${OPENROUTER_APP_URL}
      - OPENROUTER_APP_NAME=${OPENROUTER_APP_NAME:-Avatar Realtime Agent}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - DID_SERVICE=${DID_SERVICE:-clips}
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    
    # IMPORTANTE: En Coolify, NO usar labels de Traefik manualmente
    # Coolify configura Traefik automáticamente cuando agregas el dominio en la interfaz
    # Si necesitas usar labels manuales, primero verifica los entrypoints de Traefik
    # 
    # Para usar labels manuales, primero ejecuta en el servidor:
    # docker exec coolify-proxy wget -qO- http://localhost:8080/api/entrypoints
    # 
    # Luego ajusta los entrypoints según lo que encuentres
    #
    # OPCIÓN 1: Dejar que Coolify configure automáticamente (RECOMENDADO)
    # - Ve a tu aplicación en Coolify
    # - Sección "Domains" o "FQDNs"
    # - Agrega "avatar.edvio.app" con HTTPS
    # - Coolify configurará Traefik automáticamente
    #
    # OPCIÓN 2: Usar labels manuales (solo si conoces los entrypoints correctos)
    # Descomenta las labels de abajo y ajusta los entrypoints según tu configuración
    #
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.avatar.rule=Host(`avatar.edvio.app`)"
    #   - "traefik.http.routers.avatar.entrypoints=websecure"
    #   - "traefik.http.routers.avatar.tls=true"
    #   - "traefik.http.routers.avatar.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.avatar.loadbalancer.server.port=3000"
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "--tries=1", "http://127.0.0.1:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

